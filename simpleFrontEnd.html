<!DOCTYPE html>
<html>
<head>
  <title>Session + Upload Test</title>
</head>
<body>
  <h2>Init Session</h2>
  <input type="text" id="sessionId" placeholder="Enter Session ID">
  <button onclick="initSession()">Init</button>
  <p id="status"></p>

  <hr>

  <h2>Restore Session</h2>
  <select id="restoreSessionDropdown">
    <option value="">-- Select a session to restore --</option>
  </select>
  <button onclick="restoreSession()">Restore</button>
  <p id="restoreStatus"></p>

  <hr>

  <h2>Upload Image</h2>
  <input type="file" id="imageFile" accept="image/*">
  <button onclick="uploadImage()">Upload</button>
  <p id="uploadStatus"></p> <!-- ✅ added -->

  <h2>Upload PDF-like</h2>
  <input type="file" id="fileInput" accept=".doc,.docx,.pdf,.xls,.xlsx"/>
  <button onclick="uploadPDFLike()">Upload</button>
  <p id="uploadStatus"></p> <!-- ✅ reuse or make unique if you want separate statuses -->

  <hr>

  <h2>Remove Image</h2>
  <select id="removeImgDropdown">
    <option value="">-- Select an image to remove --</option>
  </select>
  <button onclick="removeImage()">Remove</button>
  <p id="removeStatus"></p>

  <hr>

  <h2>Remove PDF</h2>
  <select id="removePdfDropdown">
    <option value="">-- Select a PDF to remove --</option>
  </select>
  <button onclick="removePDF()">Remove</button>
  <p id="removePdfStatus"></p>

  <hr>

  <h2>Set Instruction Text</h2>
  <input type="text" id="instructionText" placeholder="Enter instruction text">
  <button onclick="setInstruction()">Set Instruction</button>
  <p id="instructionStatus"></p>

  <hr>

  <h2>Start LLM Session</h2>
  <button onclick="startLLMSession()">Start LLM</button>
  <p id="llmStatus"></p>

  <hr>

  <h2>Analyse PDF</h2>
  <button onclick="analysePDF()">Analyse PDF</button>
  <p id="analyseStatus"></p>

  <hr>

  <h2>Analyse Image</h2>
  <button onclick="analyseImage()">Analyse Image</button>
  <p id="analyseImgStatus"></p>

  <hr>

  <h2>Generate Study Guide</h2>
  <button onclick="generateStudyGuide()">Generate Study Guide</button>
  <pre id="studyGuideStatus"></pre> <!-- ✅ fixed ID + use <pre> for long text -->

  <hr>

  <h2>Generate Flashcard Questions</h2>
  <label for="numQuestions">Number of Questions:</label>
  <input type="number" id="numQuestions" min="1" placeholder="e.g. 10">

  <label for="difficulty">Difficulty:</label>
  <select id="difficulty">
    <option value="easy">Easy</option>
    <option value="medium">Medium</option>
    <option value="hard">Hard</option>
  </select>

  <button onclick="generateFlashcards()">Generate Flashcards</button>
  <pre id="flashcardStatus"></pre> <!-- ✅ changed to <pre> -->

  <hr>

  <h2>Generate Worksheet Questions</h2>
  <label for="numWorksheetQuestions">Number of Questions:</label>
  <input type="number" id="numWorksheetQuestions" min="1" placeholder="e.g. 10">

  <label for="worksheetDifficulty">Difficulty:</label>
  <select id="worksheetDifficulty">
    <option value="easy">Easy</option>
    <option value="medium">Medium</option>
    <option value="hard">Hard</option>
  </select>

<button onclick="generateWorksheetQuestions()">Generate Worksheet Questions</button>
<pre id="worksheetStatus"></pre>

  <hr>

  <h2>Generate Mindmap</h2>
  <button onclick="generateMindmap()">Generate Mindmap</button>
  <p id="mindmapStatus"></p>

  <hr>
  
  <h2>Retrieve Full History</h2>
  <button onclick="retrieveFullHistory()">Retrieve</button>
  <pre id="historyStatus"></pre> <!-- ✅ changed to <pre> -->

  <hr>

  <h2>Inference from Prompt</h2>
  <input type="text" id="inference-prompt" placeholder="Enter your prompt">
  <button onclick="runInference()">Run Inference</button>
  <pre id="inference-result"></pre>


  <script>
    let currentSessionId = null;

    populateRestoreSessionDropdown();

    async function initSession() {
      const id = document.getElementById("sessionId").value;
      if (!id) { alert("Please enter a session id"); return; }

      const formData = new FormData();
      formData.append("command", "init_session");
      formData.append("id", id);

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          currentSessionId = id;
          document.getElementById("status").innerText = "Session initialized successfully!";
          // Call this after session initialization
          if (currentSessionId) refreshRemoveImgDropdown();
          if (currentSessionId) refreshRemovePdfDropdown();
        } else {
          document.getElementById("status").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("status").innerText = "Error: " + err;
      }
    }

    async function populateRestoreSessionDropdown() {
      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/session_files");
        if (!response.ok) throw new Error(response.statusText);
        const data = await response.json();

        const dropdown = document.getElementById("restoreSessionDropdown");
        dropdown.innerHTML = '<option value="">-- Select a session to restore --</option>';

        Object.keys(data.sessions || {}).forEach(sessionId => {
          const opt = document.createElement("option");
          opt.value = sessionId;
          opt.text = `${sessionId} (imgs: ${data.sessions[sessionId].counts.imgs}, pdfs: ${data.sessions[sessionId].counts.pdfs})`;
          dropdown.add(opt);
        });
      } catch (err) {
        document.getElementById("restoreStatus").innerText = "Error fetching sessions: " + err;
      }
    }

    async function restoreSession() {
      const sessionId = document.getElementById("restoreSessionDropdown").value;
      if (!sessionId) { alert("Please select a session"); return; }

      const formData = new FormData();
      formData.append("command", "restore_session");
      formData.append("id", sessionId);

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("restoreStatus").innerText = "Restore success: " + (result.message || JSON.stringify(result));
          currentSessionId = sessionId;
          if (currentSessionId) refreshRemoveImgDropdown();
          if (currentSessionId) refreshRemovePdfDropdown();
        } else {
          document.getElementById("restoreStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("restoreStatus").innerText = "Error: " + err;
      }
    }

    async function uploadImage() {
      if (!currentSessionId) { alert("Please init a session first."); return; }
      const fileInput = document.getElementById("imageFile");
      if (fileInput.files.length === 0) { alert("Please select an image to upload"); return; }

      const formData = new FormData();
      formData.append("command", "append_image");
      formData.append("file", fileInput.files[0]);

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("uploadStatus").innerText = "Upload success: " + result.message;
        } else {
          document.getElementById("uploadStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("uploadStatus").innerText = "Error: " + err;
      }
    }

    async function uploadPDFLike() {
      if (!currentSessionId) { alert("Please init a session first."); return; }
      const fileInput = document.getElementById("fileInput");
      if (fileInput.files.length === 0) { alert("Please select a file to upload"); return; }

      const formData = new FormData();
      formData.append("command", "append_pdflike");
      formData.append("file", fileInput.files[0]);

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("uploadStatus").innerText = "Upload success: " + result.message;
        } else {
          document.getElementById("uploadStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("uploadStatus").innerText = "Error: " + err;
      }
    }

    async function setInstruction() {
      if (!currentSessionId) { alert("Please init a session first."); return; }
      const instructText = document.getElementById("instructionText").value;
      if (!instructText) { alert("Please enter instruction text"); return; }

      const formData = new FormData();
      formData.append("command", "set_instruct");
      formData.append("instruction_text", instructText);

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("instructionStatus").innerText = result.message;
        } else {
          document.getElementById("instructionStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("instructionStatus").innerText = "Error: " + err;
      }
    }

    async function startLLMSession() {
      if (!currentSessionId) { alert("Please init a session first."); return; }

      const formData = new FormData();
      formData.append("command", "start_LLM_session");

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("llmStatus").innerText = "LLM session started: " + result.message;
        } else {
          document.getElementById("llmStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("llmStatus").innerText = "Error: " + err;
      }
    }

    async function analysePDF() {
      if (!currentSessionId) { alert("Please init a session first."); return; }

      const formData = new FormData();
      formData.append("command", "analyse_pdf");

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("analyseStatus").innerText = "PDF analysis started: " + result.message;
        } else {
          document.getElementById("analyseStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("analyseStatus").innerText = "Error: " + err;
      }
    }

    async function analyseImage() {
      if (!currentSessionId) { alert("Please init a session first."); return; }

      const formData = new FormData();
      formData.append("command", "analyse_img");

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("analyseImgStatus").innerText = "Image analysis started: " + result.message;
        } else {
          document.getElementById("analyseImgStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("analyseImgStatus").innerText = "Error: " + err;
      }
    }

    async function generateStudyGuide() {
      if (!currentSessionId) {
        alert("Please init a session first.");
        return;
      }

      const formData = new FormData();
      formData.append("command", "generate_study_guide");

      try {
        const response = await fetch(
          "https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload",
          {
            method: "POST",
            body: formData
          }
        );

        // Always read raw text first
        const text = await response.text();
        console.log("Raw reply:", text);

        if (response.ok) {
          // Parse JSON
          let result = {};
          try {
            result = JSON.parse(text);
          } catch (err) {
            console.error("Failed to parse JSON:", err);
            document.getElementById("studyGuideStatus").innerText =
              "Failed to parse JSON:\n" + text;
            return;
          }

          // Display the last_response
          document.getElementById("studyGuideStatus").innerText =
            result.markdown || "No response content";
        } else {
          document.getElementById("studyGuideStatus").innerText =
            "Error: " + response.status + " " + response.statusText + "\nRaw: " + text;
        }
      } catch (err) {
        document.getElementById("studyGuideStatus").innerText = "Error: " + err;
      }
    }

    async function retrieveFullHistory() {
      if (!currentSessionId) { alert("Please init a session first."); return; }

      const formData = new FormData();
      formData.append("command", "retrieve_full_history");

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("historyStatus").innerText = JSON.stringify(result, null, 2);
        } else {
          document.getElementById("historyStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("historyStatus").innerText = "Error: " + err;
      }
    }

    async function generateFlashcards() {
      if (!currentSessionId) { alert("Please init a session first."); return; }

      const numQuestions = document.getElementById("numQuestions").value;
      const difficulty = document.getElementById("difficulty").value;

      if (!numQuestions || numQuestions <= 0) {
        alert("Please enter a valid number of questions");
        return;
      }

      const formData = new FormData();
      formData.append("command", "generate_flashcard_questions");
      formData.append("num_questions", numQuestions);
      formData.append("difficulty", difficulty);

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("flashcardStatus").innerText = JSON.stringify(result, null, 2);
        } else {
          document.getElementById("flashcardStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("flashcardStatus").innerText = "Error: " + err;
      }
    }

    async function generateFlashcardAnswers() {
      if (!currentSessionId) { alert("Please init a session first."); return; }

      const formData = new FormData();
      formData.append("command", "generate_flashcard_answers");

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("flashcardAnswersStatus").innerText = JSON.stringify(result, null, 2);
        } else {
          document.getElementById("flashcardAnswersStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("flashcardAnswersStatus").innerText = "Error: " + err;
      }
    }

    async function generateFlashcard() {
        if (!currentSessionId) { 
          alert("Please init a session first."); 
          return; 
        }

        const formData = new FormData();
        formData.append("command", "generate_flashcard");

        try {
          const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
            method: "POST", 
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            document.getElementById("flashcardGenStatus").innerText = JSON.stringify(result, null, 2);
          } else {
            document.getElementById("flashcardGenStatus").innerText = 
              "Error: " + response.status + " " + response.statusText;
          }
        } catch (err) {
          document.getElementById("flashcardGenStatus").innerText = "Error: " + err;
        }
      }

    async function generateWorksheetQuestions() {
      if (!currentSessionId) { 
        alert("Please init a session first."); 
        return; 
      }

      const numQuestions = document.getElementById("numWorksheetQuestions").value;
      const difficulty = document.getElementById("worksheetDifficulty").value;

      if (!numQuestions || numQuestions <= 0) {
        alert("Please enter a valid number of questions");
        return;
      }

      const formData = new FormData();
      formData.append("command", "generate_worksheet_questions");
      formData.append("num_questions", numQuestions);
      formData.append("difficulty", difficulty);

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST", 
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("worksheetStatus").innerText = JSON.stringify(result, null, 2);
        } else {
          document.getElementById("worksheetStatus").innerText = 
            "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("worksheetStatus").innerText = "Error: " + err;
      }
    }

    async function generateMindmap() {
      if (!currentSessionId) {
        alert("Please init a session first.");
        return;
      }

      const formData = new FormData();
      formData.append("command", "generate_mindmap");

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("mindmapStatus").innerText = "Mindmap generated: " + result.message;
        } else {
          document.getElementById("mindmapStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("mindmapStatus").innerText = "Error: " + err;
      }
    }

    async function runInference() {
        if (!currentSessionId) { 
            alert("Please init a session first."); 
            return; 
        }

        const prompt = document.getElementById("inference-prompt").value;
        if (!prompt) { 
            alert("Please enter a prompt"); 
            return; 
        }

        const formData = new FormData();
        formData.append("command", "inference_from_prompt");
        formData.append("prompt", prompt);

        try {
            const response = await fetch(
                "https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload",
                { method: "POST", body: formData }
            );

            const text = await response.text();
            console.log("Raw reply:", text);

            if (response.ok) {
                let result = {};
                try { 
                    result = JSON.parse(text); 
                } catch (err) {
                    console.error("Failed to parse JSON:", err);
                    document.getElementById("inference-result").innerText = "Failed to parse JSON:\n" + text;
                    return;
                }

                document.getElementById("inference-result").innerText =
                    result.last_response || "No response content";
            } else {
                document.getElementById("inference-result").innerText =
                    "Error: " + response.status + " " + response.statusText + "\nRaw: " + text;
            }
        } catch (err) {
            document.getElementById("inference-result").innerText = "Error: " + err;
        }
    }

    async function populateRemoveImgDropdown() {
      if (!currentSessionId) return;

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/session_files");
        if (!response.ok) throw new Error(response.statusText);
        const data = await response.json();

        const sessionData = data.sessions?.[currentSessionId];
        if (!sessionData) {
          document.getElementById("removeStatus").innerText = "No files found for this session.";
          return;
        }

        const dropdown = document.getElementById("removeImgDropdown");
        dropdown.innerHTML = '<option value="">-- Select an image to remove --</option>';
        sessionData.imgs.forEach(img => {
          const opt = document.createElement("option");
          opt.value = img.name;
          opt.text = `${img.name} (${(img.size_bytes/1024).toFixed(1)} KB, modified ${img.modified_iso})`;
          dropdown.add(opt);
        });
      } catch (err) {
        document.getElementById("removeStatus").innerText = "Error fetching images: " + err;
      }
    }

    // Call this whenever session is initialized or after an image is uploaded
    function refreshRemoveImgDropdown() {
        populateRemoveImgDropdown();
      }

      async function removeImage() {
        if (!currentSessionId) { alert("Please init a session first."); return; }

        const filename = document.getElementById("removeImgDropdown").value;
        if (!filename) { alert("Please select an image"); return; }

        const formData = new FormData();
        formData.append("command", "remove_img");
        formData.append("filename", filename);

        try {
          const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
            method: "POST",
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            document.getElementById("removeStatus").innerText = "Remove success: " + (result.message || JSON.stringify(result));
            populateRemoveImgDropdown(); // refresh after removal
          } else {
            document.getElementById("removeStatus").innerText = "Error: " + response.status + " " + response.statusText;
          }
        } catch (err) {
          document.getElementById("removeStatus").innerText = "Error: " + err;
        }
      }


    async function populateRemovePdfDropdown() {
      if (!currentSessionId) return;

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/session_files");
        if (!response.ok) throw new Error(response.statusText);
        const data = await response.json();

        const sessionData = data.sessions?.[currentSessionId];
        if (!sessionData) {
          document.getElementById("removePdfStatus").innerText = "No files found for this session.";
          return;
        }

        const dropdown = document.getElementById("removePdfDropdown");
        dropdown.innerHTML = '<option value="">-- Select a PDF to remove --</option>';
        sessionData.pdfs.forEach(pdf => {
          const opt = document.createElement("option");
          opt.value = pdf.name;
          opt.text = `${pdf.name} (${(pdf.size_bytes/1024).toFixed(1)} KB, modified ${pdf.modified_iso})`;
          dropdown.add(opt);
        });
      } catch (err) {
        document.getElementById("removePdfStatus").innerText = "Error fetching PDFs: " + err;
      }
    }

    // Call this whenever session is initialized or after a PDF is uploaded
    function refreshRemovePdfDropdown() {
      populateRemovePdfDropdown();
    }

    async function removePDF() {
      if (!currentSessionId) { alert("Please init a session first."); return; }

      const filename = document.getElementById("removePdfDropdown").value;
      if (!filename) { alert("Please select a PDF"); return; }

      const formData = new FormData();
      formData.append("command", "remove_pdf");
      formData.append("filename", filename);

      try {
        const response = await fetch("https://txp-tckxn64wn5vtgip72-kzoemq8qw-custom.service.onethingrobot.com/upload", {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("removePdfStatus").innerText = "Remove success: " + (result.message || JSON.stringify(result));
          populateRemovePdfDropdown(); // refresh after removal
        } else {
          document.getElementById("removePdfStatus").innerText = "Error: " + response.status + " " + response.statusText;
        }
      } catch (err) {
        document.getElementById("removePdfStatus").innerText = "Error: " + err;
      }
    }

  </script>
</body>
</html>
